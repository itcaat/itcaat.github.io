---
title: "CPU - –≤—Å—ë —á—Ç–æ –≤—ã —Ö–æ—Ç–µ–ª–∏ –∑–Ω–∞—Ç—å, –Ω–æ —Å—Ç–µ—Å–Ω—è–ª–∏—Å—å —Å–ø—Ä–æ—Å–∏—Ç—å"
date: 2025-08-10T13:39:35+03:00
description: "–°–µ–≥–æ–¥–Ω—è –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –¥–≤–∞ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: CPU Usage (–ø—Ä–æ—Ü–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞) –∏ Load Average (—Å—Ä–µ–¥–Ω—é—é –∑–∞–≥—Ä—É–∑–∫—É). –û–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ –Ω–µ –≤—Å–µ –ø–æ–Ω–∏–º–∞—é—Ç –∏ –Ω–µ–≤–µ—Ä–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–∏—Ç–∏—Ä—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç htop –∏–ª–∏ glances –æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ. –ú—ã –∑–∞–≥–ª—è–Ω–µ–º –ø–æ–¥ –∫–∞–ø–æ—Ç htop –∏ —Ä–∞–∑–±–µ—Ä–µ–º, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ –æ–Ω –ø–æ–ª—É—á–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ CPU. –ù–æ –ø—Ä–µ–∂–¥–µ —á–µ–º –º—ã –Ω–∞—á–Ω–µ–º –¥–∞–≤–∞–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–º—Å—è —á—Ç–æ –∂–µ —Ç–∞–∫–æ–µ —Ç–∞–∫—Ç–æ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. "
tags: [sre]
thumbnail: "images/image.png"
---

–°–µ–≥–æ–¥–Ω—è –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –¥–≤–∞ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: CPU Usage (–ø—Ä–æ—Ü–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞) –∏ Load Average (—Å—Ä–µ–¥–Ω—é—é –∑–∞–≥—Ä—É–∑–∫—É). –û–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ –Ω–µ –≤—Å–µ –ø–æ–Ω–∏–º–∞—é—Ç –∏ –Ω–µ–≤–µ—Ä–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–∏—Ç–∏—Ä—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç htop –∏–ª–∏ glances –æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ. –ú—ã –∑–∞–≥–ª—è–Ω–µ–º –ø–æ–¥ –∫–∞–ø–æ—Ç htop –∏ —Ä–∞–∑–±–µ—Ä–µ–º, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ –æ–Ω –ø–æ–ª—É—á–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ CPU. –ù–æ –ø—Ä–µ–∂–¥–µ —á–µ–º –º—ã –Ω–∞—á–Ω–µ–º –¥–∞–≤–∞–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–º—Å—è —á—Ç–æ –∂–µ —Ç–∞–∫–æ–µ —Ç–∞–∫—Ç–æ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. 

```
 ‚Äî –ü–æ—á–µ–º—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –º–µ—Ä—è–µ—Ç –≤ —Ç–∞–∫—Ç–∞—Ö? 
 ‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –≤ ¬´–ø–æ–ø—É–≥–∞—è—Ö¬ª —É–∂–µ –∑–∞–Ω—è—Ç–æ.
```

–¢–∞–∫—Ç–æ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞ - —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–∫—Ç–æ–≤ (—Ü–∏–∫–ª–æ–≤), –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É. –¢–∞–∫—Ç ‚Äî —ç—Ç–æ ¬´—Ç–∏–∫¬ª –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω—ã—Ö —á–∞—Å–æ–≤. –¢–∞–∫—Ç–æ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3 –ì–ì—Ü) = 3 –º–∏–ª–ª–∏–∞—Ä–¥–∞ ¬´—É–¥–∞—Ä–æ–≤¬ª –≤ —Å–µ–∫—É–Ω–¥—É. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ CPU ‚Äî —ç—Ç–æ —Ñ–∞–±—Ä–∏–∫–∞, –≥–¥–µ –∫–∞–∂–¥—ã–π —Ä–∞–±–æ—á–∏–π (—Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä) –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–≤–æ—é —á–∞—Å—Ç—å –∑–∞–¥–∞—á–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ —Å–∏–≥–Ω–∞–ª—É –º–µ—Ç—Ä–æ–Ω–æ–º–∞. 1 —Ç–∞–∫—Ç = 1 —É–¥–∞—Ä –º–µ—Ç—Ä–æ–Ω–æ–º–∞. 

–ü–æ—á–µ–º—É —ç—Ç–æ —É–¥–æ–±–Ω–æ? –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã CPU —Ä–∞–±–æ—Ç–∞—é—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–∫–∞–∫ –æ—Ä–∫–µ—Å—Ç—Ä –ø–æ–¥ –¥–∏—Ä–∏–∂—ë—Ä–∞). –õ–µ–≥–∫–æ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–≤–µ–π–µ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–¥–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç 10 —Å—Ç–∞–¥–∏–π –∑–∞ 10 —Ç–∞–∫—Ç–æ–≤). –î–æ–ø—É—Å—Ç–∏–º —É –Ω–∞—Å –µ—Å—Ç—å 2 –æ–ø–µ—Ä–∞—Ü–∏–∏ –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º: —Å–ª–æ–∂–µ–Ω–∏–µ (ADD) –∏ –¥–µ–ª–µ–Ω–∏–µ (DIV). –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å–ª–æ–∂–µ–Ω–∏—è, –≥–¥–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø—Ä–æ—Å—Ç–æ "—Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –±–∏—Ç—ã", –¥–µ–ª–µ–Ω–∏–µ - —ç—Ç–æ –º–Ω–æ–≥–æ—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ –¥–µ–ª–µ–Ω–∏–µ –≤ —Å—Ç–æ–ª–±–∏–∫, –Ω–æ –≤ –¥–≤–æ–∏—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –ò–∑-–∑–∞ —ç—Ç–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∑–∞—Ç—Ä–∞—á–µ–Ω—ã –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é DIV –±—É–¥–µ—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ (–∞ –∏–Ω–æ–≥–¥–∞ –∏ –≤ –¥–µ—Å—è—Ç–∫–∏ —Ä–∞–∑ –±–æ–ª—å—à–µ) —á–µ–º –æ–ø–µ—Ä–∞—Ü–∏—è —Å–ª–æ–∂–µ–Ω–∏—è. –¢–∞–∫ —á—Ç–æ –≤ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —è–¥–µ—Ä, —Ä–∞–∑–º–µ—Ä–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–µ—à-–ø–∞–º—è—Ç–∏, –Ω–∞–ª–∏—á–∏—è Turbo Boost, —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –∏ –µ—â–µ –∫—É—á–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ª–æ–∂–∏–ª –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –≤ —Å–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä.

### –ß—Ç–æ —Ç–∞–∫–æ–µ Load Average

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: –≤–∞—Å —Ä–∞–∑–±—É–¥–∏–ª –∞–ª–µ—Ä—Ç –≤ 3 —É—Ç—Ä–∞. –ù–∞ dashboard –≤—ã –≤–∏–¥–∏—Ç–µ:
```
Load Average: 8.45 / 12.30 / 15.67
CPU Usage: 45%
```

**–í–æ–ø—Ä–æ—Å**: —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞ –∏–ª–∏ –Ω–µ—Ç? –ù—É–∂–Ω–æ –ª–∏ —ç–∫—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –º–æ–∂–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ –∏–¥–∏ —Å–ø–∞—Ç—å –¥–∞–ª—å—à–µ?

–ë–µ–∑ –ø–æ–Ω–∏–º–∞–Ω–∏—è Load Average –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ê –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, —Å–∫–æ–ª—å–∫–æ —É –≤–∞—Å CPU cores.

![–ò–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ linux kernel](images/loadavg-kernel.png)

Load Average ‚Äî —ç—Ç–æ **–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å**. –°—é–¥–∞ –≤—Ö–æ–¥—è—Ç:
- –ü—Ä–æ—Ü–µ—Å—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ **–∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç CPU** 
- –ü—Ä–æ—Ü–µ—Å—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ **–∂–¥—É—Ç CPU** (–≤ –æ—á–µ—Ä–µ–¥–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞)
- –ü—Ä–æ—Ü–µ—Å—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ **–∂–¥—É—Ç I/O** (disk, network)

**–¢—Ä–∏ —Ü–∏—Ñ—Ä—ã** –æ–∑–Ω–∞—á–∞—é—Ç —Å—Ä–µ–¥–Ω–µ–µ –∑–∞ 1, 5 –∏ 15 –º–∏–Ω—É—Ç.

### –ö–∞–∫ htop –ø–æ–ª—É—á–∞–µ—Ç Load Average –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö

–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è load average –≤ Linux —É–∂–µ –ø–æ–¥—Å—á–∏—Ç–∞–Ω—ã —è–¥—Ä–æ–º –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–ª–æ–∂–µ–Ω—ã –≤ `/proc/loadavg`. 

```bash
$ cat /proc/loadavg
1.23 2.45 3.67     2/312  1425
# ^    ^    ^       ^      ^
# 1m   5m  15m    running/ lastpid
#                 total
```

Htop –ø—Ä–æ—Å—Ç–æ –≤—ã—á–∏—Ç—ã–≤–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

```c
// https://github.com/htop-dev/htop/blob/main/linux/Platform.c#L279-L300
void Platform_getLoadAverage(double* one, double* five, double* fifteen) {
   char loaddata[128] = {0};
   ...
   ssize_t loadread = xReadfile(PROCDIR "/loadavg", loaddata, sizeof(loaddata));
   if (loadread < 1)
      return;
   ...
   int r = sscanf(loaddata, "%lf %lf %lf", &scanOne, &scanFive, &scanFifteen);
   ...
}
```

–ù–æ –¥–∞–≤–∞–π—Ç–µ –∑–∞–≥–ª—è–Ω–µ–º –≤ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —è–¥—Ä–∞ Linux –∏ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ñ–∞–π–ª `/proc/loadavg`:

```c
// https://github.com/torvalds/linux/blob/master/fs/proc/loadavg.c
static int loadavg_proc_show(struct seq_file *m, void *v)
{
    unsigned long avnrun[3];

    // –ü–æ–ª—É—á–∞–µ–º Load Average –æ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —è–¥—Ä–∞
    get_avenrun(avnrun, FIXED_1/200, 0);
    //                  ^^^^^^^^^^^ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è /proc/loadavg
    seq_printf(m, "%lu.%02lu %lu.%02lu %lu.%02lu %u/%d %d\n",
        LOAD_INT(avnrun[0]), LOAD_FRAC(avnrun[0]),     // 1 –º–∏–Ω
        LOAD_INT(avnrun[1]), LOAD_FRAC(avnrun[1]),     // 5 –º–∏–Ω  
        LOAD_INT(avnrun[2]), LOAD_FRAC(avnrun[2]),     // 15 –º–∏–Ω
        nr_running(),        // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ R —Å–æ—Å—Ç–æ—è–Ω–∏—è
        nr_threads,          // –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤
        idr_get_cursor(...) - 1); // –ø–æ—Å–ª–µ–¥–Ω–∏–π PID
    return 0;
}
```

> –Ø–¥—Ä–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç Load Average –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥, –∏—Å–ø–æ–ª—å–∑—É—è —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ. –ü–æ—ç—Ç–æ–º—É —Ä–µ–∑–∫–∏–µ —Å–∫–∞—á–∫–∏ "—Ä–∞–∑–º–∞–∑—ã–≤–∞—é—Ç—Å—è" –ø–æ –≤—Ä–µ–º–µ–Ω–∏.

**–ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. **`get_avenrun()`** ‚Äî –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è Load Average –æ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —è–¥—Ä–∞
2. **`FIXED_1/200`** ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (5 —Å–µ–∫—É–Ω–¥ –∏–∑ 1000)
3. **`nr_running()`** ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `TASK_RUNNING` 
4. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑ fixed-point —Ñ–æ—Ä–º–∞—Ç–∞ –≤ –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ —á–∏—Å–ª–∞

–î–∞–≤–∞–π—Ç–µ –Ω—ã—Ä–Ω—ë–º –µ—â–µ –≥–ª—É–±–∂–µ. –ú—ã —É–∂–µ –Ω–∞—à–ª–∏, —á—Ç–æ –≤ `loadavg_proc_show` –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç—Å—è –∏–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞, –Ω–æ –Ω–∞–º –Ω—É–∂–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –¥–æ –∫–æ–Ω—Ü–∞ –∫–∞–∫ —Å—á–∏—Ç–∞–µ—Ç —è–¥—Ä–æ.

```c
// https://github.com/torvalds/linux/blob/master/kernel/sched/loadavg.c
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —è–¥—Ä–∞
unsigned long avenrun[3];           // –ù–∞—à–∏ 1min, 5min, 15min –∑–Ω–∞—á–µ–Ω–∏—è
atomic_long_t calc_load_tasks;      // –°—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
void calc_global_load(void)
{
    long active, delta;
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á —Å–æ –≤—Å–µ—Ö CPU
    active = atomic_long_read(&calc_load_tasks);
    active = active > 0 ? active * FIXED_1 : 0;  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ fixed-point
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
    avenrun[0] = calc_load(avenrun[0], EXP_1, active);   // 1 –º–∏–Ω—É—Ç–∞
    avenrun[1] = calc_load(avenrun[1], EXP_5, active);   // 5 –º–∏–Ω—É—Ç  
    avenrun[2] = calc_load(avenrun[2], EXP_15, active);  // 15 –º–∏–Ω—É—Ç
}

// –ö–∞–∂–¥—ã–π CPU –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ–π —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
void calc_global_load_tick(struct rq *this_rq)
{
    long delta;
    
    // nr_running + nr_uninterruptible = –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
    delta = calc_load_fold_active(this_rq, 0);
    if (delta)
        atomic_long_add(delta, &calc_load_tasks);  // –ê—Ç–æ–º–∞—Ä–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –∫ –æ–±—â–µ–º—É —Å—á–µ—Ç—á–∏–∫—É
}
```

–ú—ã —É–∂–µ –≥–¥–µ —Ç–æ –±–ª–∏–∑–∫–æ - –æ—Å—Ç–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —á—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ `calc_load(...)`.

```c
// https://github.com/torvalds/linux/blob/master/include/linux/sched/loadavg.h
#define FSHIFT    11        // 11 –±–∏—Ç —Ç–æ—á–Ω–æ—Å—Ç–∏ (2048 = 1.0)
#define FIXED_1   (1<<FSHIFT)  // 2048 = 1.0 –≤ fixed-point
#define LOAD_FREQ (5*HZ+1)  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
#define EXP_1     1884      // exp(-5sec/1min)  = 0.920 –≤ fixed-point
#define EXP_5     2014      // exp(-5sec/5min)  = 0.983 –≤ fixed-point
#define EXP_15    2037      // exp(-5sec/15min) = 0.994 –≤ fixed-point

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ (—Ç–æ—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è):
static inline unsigned long
calc_load(unsigned long load, unsigned long exp, unsigned long active)
{
    unsigned long newload;
    
    // newload = load * exp + active * (FIXED_1 - exp)
    // –≠—Ç–æ –∏ –µ—Å—Ç—å: —Å—Ç–∞—Ä–æ–µ_–∑–Ω–∞—á–µ–Ω–∏–µ * –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç + –Ω–æ–≤–æ–µ * (1 - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç)
    newload = load * exp + active * (FIXED_1 - exp);
    
    // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
    if (active >= load)
        newload += FIXED_1-1;
    
    return newload / FIXED_1;  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±—ã—á–Ω–æ–µ —á–∏—Å–ª–æ
}

// –ú–∞–∫—Ä–æ—Å—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ /proc/loadavg
#define LOAD_INT(x)  ((x) >> FSHIFT)                    // –¶–µ–ª–∞—è —á–∞—Å—Ç—å
#define LOAD_FRAC(x) LOAD_INT(((x) & (FIXED_1-1)) * 100) // –î—Ä–æ–±–Ω–∞—è —á–∞—Å—Ç—å
```

### üî¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –∏–ª–∏ –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —è–¥—Ä–µ

–î–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º –ø—Å–µ–≤–¥–æ-—Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç Load Average –≤ —è–¥—Ä–µ:

```c
// –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
unsigned long avenrun[3] = {0, 0, 0};  // Load = 0.00 / 0.00 / 0.00

// –ú–æ–º–µ–Ω—Ç t=0: –≤–Ω–µ–∑–∞–ø–Ω–æ –ø–æ—è–≤–∏–ª–æ—Å—å 4 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞
unsigned long active = 4 * FIXED_1;   // 4.0 –≤ fixed-point = 4 * 2048 = 8192

// –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ (–ø–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ):
avenrun[0] = calc_load(0, EXP_1, active);
// = (0 * 1884 + 8192 * (2048-1884)) / 2048
// = (0 + 8192 * 164) / 2048  
// = 1343488 / 2048 = 656 = 0.32 –≤ fixed-point

avenrun[1] = calc_load(0, EXP_5, active);  
// = (0 * 2014 + 8192 * (2048-2014)) / 2048
// = (0 + 8192 * 34) / 2048
// = 278528 / 2048 = 136 = 0.067 –≤ fixed-point

// –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ /proc/loadavg: "0.32 0.07 0.00"
```

–°—É–ø–µ—Ä! –ú—ã –¥–æ–±—Ä–∞–ª–∏—Å—å –¥–æ —Ç–æ–≥–æ –∫–∞–∫ —Å–∞–º–æ —è–¥—Ä–æ —Å—á–∏—Ç–∞–µ—Ç load avarage –∏ –≥–æ—Ç–æ–≤—ã –æ—Ç—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è –æ—Ç –Ω–µ–≥–æ –∏ –ø–æ–¥–≤–æ–¥–∏—Ç—å –∏—Ç–æ–≥–∏. 

---

## –ß–∞—Å—Ç—å 2: CPU Usage - –∫–∞–∫ –Ω–µ –ø–æ–ø–∞—Å—Ç—å –≤ –ª–æ–≤—É—à–∫—É "–Ω–∏–∑–∫–æ–≥–æ CPU"

### –°—Ü–µ–Ω–∞—Ä–∏–π –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ SRE

–ü—è—Ç–Ω–∏—Ü–∞, 18:00. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∂–∞–ª—É—é—Ç—Å—è –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É API. –í—ã –∑–∞—Ö–æ–¥–∏—Ç–µ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

```
CPU Usage: 25%
Load Average: 0.8 / 1.2 / 1.5  (–Ω–∞ 4-core —Å–µ—Ä–≤–µ—Ä–µ)
```

**–ù–æ–≤–∏—á–æ–∫ —Å–∫–∞–∂–µ—Ç:** "CPU –Ω–∏–∑–∫–∏–π, –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ"
**–û–ø—ã—Ç–Ω—ã–π SRE –ø–æ–¥—É–º–∞–µ—Ç:** "–ê —á—Ç–æ —Ç–∞–º —Å iowait? –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º—Å—è –ª–∏ –º—ã –Ω–∞ I/O?"

–°–µ–≥–æ–¥–Ω—è —Ä–∞–∑–±–µ—Ä–µ–º, –∫–∞–∫ **–ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–∏—Ç–∞—Ç—å** CPU –º–µ—Ç—Ä–∏–∫–∏ –∏ **–Ω–µ –ø–æ–ø–∞–¥–∞—Ç—å –≤ –ª–æ–≤—É—à–∫–∏**.

### CPU Usage: —á—Ç–æ —ç—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ?

CPU Usage = **–ø—Ä–æ—Ü–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏, –∫–æ–≥–¥–∞ CPU –ù–ï –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–ª**

–ù–æ CPU –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–Ω—è—Ç —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—â–∞–º–∏:
- üü¢ **user** ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- üü° **system** ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã (—Ñ–∞–π–ª—ã, —Å–µ—Ç—å, –ø–∞–º—è—Ç—å)  
- üî¥ **iowait** ‚Äî –∂–¥–µ–º –¥–∏—Å–∫/SSD
- üü† **irq/softirq** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π (—Å–µ—Ç—å, –¥–∏—Å–∫–∏)
- üü£ **steal** ‚Äî –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä –∑–∞–±—Ä–∞–ª CPU (–∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è –æ–±–ª–∞–∫–∞)

**–ö–ª—é—á–µ–≤–æ–π –∏–Ω—Å–∞–π—Ç –¥–ª—è SRE:** –í—ã—Å–æ–∫–∏–π **iowait** –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ CPU –∂–¥–µ—Ç –¥–∏—Å–∫. –í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–æ—Ä–º–æ–∑–∏—Ç, –Ω–æ "CPU Usage" –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∏–∑–∫–∏–º!

### –ö–∞–∫ —è–¥—Ä–æ –û–° —Å–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

–Ø–¥—Ä–æ –≤–µ–¥–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ CPU core –≤ **jiffies** (—Ç–∏–∫–∏ —Ç–∞–π–º–µ—Ä–∞):

```c
// –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ —è–¥—Ä–µ Linux
struct cpu_time {
    unsigned long user;      // –í—Ä–µ–º—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ
    unsigned long nice;      // –í—Ä–µ–º—è nice-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤  
    unsigned long system;    // –í—Ä–µ–º—è –≤ —Ä–µ–∂–∏–º–µ —è–¥—Ä–∞
    unsigned long idle;      // –í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è
    unsigned long iowait;    // –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è I/O
    unsigned long irq;       // –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
    // ... –∏ –µ—â–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ
};
```

–≠—Ç–∏ —Å—á–µ—Ç—á–∏–∫–∏ **–º–æ–Ω–æ—Ç–æ–Ω–Ω–æ —Ä–∞—Å—Ç—É—Ç** —Å –º–æ–º–µ–Ω—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã. –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å **—Ç–µ–∫—É—â—É—é –∑–∞–≥—Ä—É–∑–∫—É**, –Ω—É–∂–Ω–æ –≤—ã—á–∏—Å–ª–∏—Ç—å **–¥–µ–ª—å—Ç—É** –º–µ–∂–¥—É –¥–≤—É–º—è –∏–∑–º–µ—Ä–µ–Ω–∏—è–º–∏.

### –ö–∞–∫ htop —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ Linux: /proc/stat

Linux –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç CPU —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ `/proc/stat`:

```bash
$ cat /proc/stat
cpu  123456 7890 12345 67890 5432 1098 765 0 0 0
cpu0 12345 789 1234 6789 543 109 76 0 0 0
cpu1 11111 800 1111 6100 489 989 89 0 0 0
# ^  ^     ^   ^    ^    ^   ^   ^  ^ ^ ^
# |  user nice sys idle iow irq si st gu gn
```

**–ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç —ç—Ç–∏ —á–∏—Å–ª–∞:**
- **user** (123456) ‚Äî jiffies –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ
- **nice** (7890) ‚Äî jiffies nice-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- **system** (12345) ‚Äî jiffies –≤ —Ä–µ–∂–∏–º–µ —è–¥—Ä–∞
- **idle** (67890) ‚Äî jiffies –ø—Ä–æ—Å—Ç–æ—è ‚¨ÖÔ∏è **—Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ –≤ –Ω–æ—Ä–º–µ**
- **iowait** (5432) ‚Äî jiffies –æ–∂–∏–¥–∞–Ω–∏—è I/O ‚¨ÖÔ∏è **—Å–ª–µ–¥–∏—Ç–µ –∑–∞ —ç—Ç–∏–º!**
- **irq** (1098) ‚Äî jiffies –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
- **softirq** (765) ‚Äî jiffies –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
- **steal** ‚Äî –≤—Ä–µ–º—è, —É–∫—Ä–∞–¥–µ–Ω–Ω–æ–µ –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä–æ–º ‚¨ÖÔ∏è **–≤–∞–∂–Ω–æ –≤ –æ–±–ª–∞–∫–µ!**

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö htop

```c
typedef struct CPUData_ {
   // –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ —Å –∑–∞–≥—Ä—É–∑–∫–∏)
   unsigned long long int userTime;       
   unsigned long long int systemTime;     
   unsigned long long int idleTime;       
   unsigned long long int ioWaitTime;     // ‚¨ÖÔ∏è –ö–ª—é—á–µ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞ –¥–ª—è SRE!
   unsigned long long int stealTime;      // ‚¨ÖÔ∏è –í–∞–∂–Ω–æ –¥–ª—è –æ–±–ª–∞—á–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤!

   // –î–µ–ª—å—Ç—ã –º–µ–∂–¥—É –∏–∑–º–µ—Ä–µ–Ω–∏—è–º–∏ (—Ç–æ, —á—Ç–æ –º—ã –≤–∏–¥–∏–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)
   unsigned long long int userPeriod;
   unsigned long long int systemPeriod;
   unsigned long long int ioWaitPeriod;   // ‚¨ÖÔ∏è –í—ã—Å–æ–∫–∏–π = –ø—Ä–æ–±–ª–µ–º—ã —Å I/O
   unsigned long long int stealPeriod;    // ‚¨ÖÔ∏è –í—ã—Å–æ–∫–∏–π = noisy neighbor

   bool online;                           // CPU –∞–∫—Ç–∏–≤–µ–Ω/–æ—Ç–∫–ª—é—á–µ–Ω
} CPUData;
```

### –°–±–æ—Ä –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### Linux: —á—Ç–µ–Ω–∏–µ –∏–∑ /proc/stat

–§—É–Ω–∫—Ü–∏—è `LinuxMachine_scanCPUTime()` —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `/proc/stat`:

```c
static void LinuxMachine_scanCPUTime(LinuxMachine* this) {
   FILE* file = fopen(PROCSTATFILE, "r");  // "/proc/stat"
   
   for (unsigned int i = 0; i <= super->existingCPUs; i++) {
      char buffer[PROC_LINE_LENGTH + 1];
      unsigned long long int usertime, nicetime, systemtime, idletime;
      unsigned long long int ioWait = 0, irq = 0, softIrq = 0, steal = 0, guest = 0, guestnice = 0;

      // –ß—Ç–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∞:
      // cpu  123456 7890 12345 67890 123 456 789 0 0 0
      // cpu0 12345 789 1234 6789 12 45 78 0 0 0
      
      if (i == 0) {
         // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö CPU
         sscanf(buffer, "cpu  %16llu %16llu %16llu %16llu %16llu %16llu %16llu %16llu %16llu %16llu", 
                &usertime, &nicetime, &systemtime, &idletime, &ioWait, &irq, &softIrq, &steal, &guest, &guestnice);
      } else {
         // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ CPU
         unsigned int cpuid;
         sscanf(buffer, "cpu%4u %16llu %16llu %16llu %16llu %16llu %16llu %16llu %16llu %16llu %16llu", 
                &cpuid, &usertime, &nicetime, &systemtime, &idletime, &ioWait, &irq, &softIrq, &steal, &guest, &guestnice);
      }
```

#### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```c
      // Guest time —É–∂–µ —É—á—Ç–µ–Ω–æ –≤ usertime, –∏–∑–±–µ–≥–∞–µ–º –¥–≤–æ–π–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞
      usertime -= guest;
      nicetime -= guestnice;
      
      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
      unsigned long long int idlealltime = idletime + ioWait;
      unsigned long long int systemalltime = systemtime + irq + softIrq;
      unsigned long long int virtalltime = guest + guestnice;
      unsigned long long int totaltime = usertime + nicetime + systemalltime + idlealltime + steal + virtalltime;
```

### –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –¥–µ–ª—å—Ç

Htop –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **saturating subtraction** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞–∑–Ω–æ—Å—Ç–µ–π:

```c
// –í Macros.h
static inline unsigned long long saturatingSub(unsigned long long a, unsigned long long b) {
   return a > b ? a - b : 0;  // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è
}

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ LinuxMachine_scanCPUTime()
cpuData->userPeriod = saturatingSub(usertime, cpuData->userTime);
cpuData->nicePeriod = saturatingSub(nicetime, cpuData->niceTime);
cpuData->systemPeriod = saturatingSub(systemtime, cpuData->systemTime);
cpuData->totalPeriod = saturatingSub(totaltime, cpuData->totalTime);

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞
cpuData->userTime = usertime;
cpuData->niceTime = nicetime;
cpuData->systemTime = systemtime;
cpuData->totalTime = totaltime;
```

**–ü–æ—á–µ–º—É saturating subtraction –≤–∞–∂–Ω–∞:**
- –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç integer overflow –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª—É—á–∞–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã –∏–ª–∏ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤

–í `Platform_setCPUValues()` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤:

```c
double Platform_setCPUValues(Meter* this, unsigned int cpu) {
   const LinuxMachine* lhost = (const LinuxMachine*) this->host;
   const CPUData* cpuData = &(lhost->cpuData[cpu]);
   
   // –ò–∑–±–µ–≥–∞–µ–º –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
   double total = (double)(cpuData->totalPeriod == 0 ? 1 : cpuData->totalPeriod);
   double* v = this->values;

   if (!cpuData->online) {
      this->curItems = 0;
      return NAN;  // CPU –æ—Ç–∫–ª—é—á–µ–Ω
   }

   // –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤: (–≤—Ä–µ–º—è_–≤_—Ä–µ–∂–∏–º–µ / –æ–±—â–µ–µ_–≤—Ä–µ–º—è) * 100
   v[CPU_METER_NICE]    = cpuData->nicePeriod / total * 100.0;
   v[CPU_METER_NORMAL]  = cpuData->userPeriod / total * 100.0;
   v[CPU_METER_KERNEL]  = cpuData->systemPeriod / total * 100.0;
   v[CPU_METER_IRQ]     = cpuData->irqPeriod / total * 100.0;
   v[CPU_METER_SOFTIRQ] = cpuData->softIrqPeriod / total * 100.0;
   v[CPU_METER_STEAL]   = cpuData->stealPeriod / total * 100.0;
   v[CPU_METER_GUEST]   = cpuData->guestPeriod / total * 100.0;
   v[CPU_METER_IOWAIT]  = cpuData->ioWaitPeriod / total * 100.0;

   // –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CPU
   percent = sumPositiveValues(v, this->curItems);
   percent = MINIMUM(percent, 100.0);  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É
   
   return percent;
}
```

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### sumPositiveValues()

```c
double sumPositiveValues(const double* array, size_t count) {
   double sum = 0.0;
   for (size_t i = 0; i < count; i++) {
      if (isPositive(array[i]))  // –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç NaN –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
         sum += array[i];
   }
   return sum;
}
```

–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–æ–±–∞—Å—Ç–Ω–æ—Å—Ç—å, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å—É–º–º–∏—Ä—É—è —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∞–ª–≥–æ—Ä–∏—Ç–º–∞

1. **–î–µ–ª—å—Ç–∞-–∏–∑–º–µ—Ä–µ–Ω–∏—è**: –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ä–∞–∑–Ω–æ—Å—Ç—è—Ö –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º–∏ –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è–º–∏
2. **–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫**: Saturating subtraction –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
3. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è**: –í—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É 0-100%
4. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**: –ü–ª–∞—Ç—Ñ–æ—Ä–º–æ-–∑–∞–≤–∏—Å–∏–º—ã–π –∫–æ–¥ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö
5. **–†–æ–±–∞—Å—Ç–Ω–æ—Å—Ç—å**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å–æ–±—ã—Ö —Å–ª—É—á–∞–µ–≤ (–æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ CPU, –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è SRE: —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏

### 1. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤

**‚ùå –ü–ª–æ—Ö–æ:**
```yaml
alert: HighCPU
expr: cpu_usage > 80%
```

**‚úÖ –•–æ—Ä–æ—à–æ:**
```yaml  
alert: HighCPUUser
expr: cpu_user > 70%

alert: HighIOWait  
expr: cpu_iowait > 30%  # –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–∏—Å–∫–∞–º–∏!

alert: HighSteal
expr: cpu_steal > 20%   # Noisy neighbor –≤ –æ–±–ª–∞–∫–µ!
```

### 2. –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –ø—Ä–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞—Ö

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –í—ã—Å–æ–∫–∏–π Load Average, –Ω–æ –Ω–∏–∑–∫–∏–π CPU%

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
Load: 8.5 / 12.1 / 15.2  (–Ω–∞ 4-core)  ‚¨ÖÔ∏è –†–∞—Å—Ç–µ—Ç!
CPU: user:15% sys:10% iowait:65%      ‚¨ÖÔ∏è –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ I/O!

# –î–µ–π—Å—Ç–≤–∏—è:
1. iostat -x 1    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∏—Å–∫–∏
2. iotop          # –ù–∞–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å-–≤–∏–Ω–æ–≤–Ω–∏–∫  
3. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å IOPS –∏–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ SSD
```

### 3. –û–±–ª–∞—á–Ω—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã: —Å–ª–µ–¥–∏—Ç–µ –∑–∞ steal

```bash
# –ï—Å–ª–∏ steal > 10% –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è:
CPU: user:30% sys:10% steal:25%  ‚¨ÖÔ∏è –ü—Ä–æ–±–ª–µ–º–∞!

# –î–µ–π—Å—Ç–≤–∏—è:
1. –ü–æ–º–µ–Ω—è—Ç—å —Ç–∏–ø –∏–Ω—Å—Ç–∞–Ω—Å–∞ (–∏–∑–±–µ–∂–∞—Ç—å shared CPU)
2. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥—É—é AZ
3. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å dedicated hosts
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ó–Ω–∞–π—Ç–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:**
- –ß—Ç–µ–Ω–∏–µ `/proc/stat` ‚Äî ~0.001ms (–æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ)
- –ß—Ç–µ–Ω–∏–µ `/proc/[pid]/stat` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ ‚Äî –¥–æ—Ä–æ–∂–µ
- –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è htop –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî 1.5 —Å–µ–∫—É–Ω–¥—ã

**–í—ã–≤–æ–¥ –¥–ª—è SRE:** CPU –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∞–º –ø–æ —Å–µ–±–µ –Ω–µ –Ω–∞–≥—Ä—É–∂–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É. –ï—Å–ª–∏ htop —Ç–æ—Ä–º–æ–∑–∏—Ç ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏–ª–∏ –≤ I/O.

### 5. –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

```bash
# ‚úÖ –ó–¥–æ—Ä–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:
Load: 2.1 / 2.0 / 1.9    (–Ω–∞ 4-core)
CPU: user:45% sys:15% idle:40% iowait:0%

# ‚ö†Ô∏è –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:  
Load: 1.2 / 1.8 / 2.5    (—Ä–∞—Å—Ç—É—â–∏–π —Ç—Ä–µ–Ω–¥)
CPU: user:30% sys:20% idle:35% iowait:15%

# üî• –ü—Ä–æ–±–ª–µ–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:
Load: 8.5 / 12.1 / 15.2  
CPU: user:15% sys:10% idle:10% iowait:65%
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è SRE

–ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–æ–≥–æ, **–∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–∞—à–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**, ‚Äî —ç—Ç–æ –Ω–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å. –≠—Ç–æ **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞–Ω–∏—è**, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç:

1. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–ª–µ—Ä—Ç—ã** –≤ 3 —É—Ç—Ä–∞
2. **–ë—ã—Å—Ç—Ä–µ–µ –Ω–∞—Ö–æ–¥–∏—Ç—å root cause** –≤–æ –≤—Ä–µ–º—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤  
3. **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ SLI/SLO**
4. **–ò–∑–±–µ–≥–∞—Ç—å –ª–æ–∂–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤** –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥:** Load Average –∏ CPU Usage ‚Äî —ç—Ç–æ **—Ä–∞–∑–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ø–æ–ª–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞. Load –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **–¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º—É**, CPU% –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **—á–µ–º –∏–º–µ–Ω–Ω–æ –∑–∞–Ω—è—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä**.

–ò–∑—É—á–∞–π—Ç–µ —Å–≤–æ–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –ø–æ–Ω–∏–º–∞–π—Ç–µ –∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –∏ –≤–∞—à–∏ –¥–µ–∂—É—Ä—Å—Ç–≤–∞ —Å—Ç–∞–Ω—É—Ç —Å–ø–æ–∫–æ–π–Ω–µ–µ! üöÄ

---

*–ú–∞—Ç–µ—Ä–∏–∞–ª –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ htop. –ü–æ–ª–µ–∑–Ω–æ –∏–∑—É—á–∏—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–º–∏ –≤—ã –ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —ç—Ç–æ –¥–µ–ª–∞–µ—Ç –≤–∞—Å –ª—É—á—à–∏–º SRE!*