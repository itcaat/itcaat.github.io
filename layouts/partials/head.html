{{- define "feathericon" -}}
  {{- $featherURL := "https://unpkg.com/feather-icons@4.29.2/dist/feather-sprite.svg" -}}
  {{ if not (.UseCDN | default false) -}}
    {{- $featherURL = (resources.Get "svg/feather-sprite.svg" | fingerprint).RelPermalink -}}
  {{- end -}}
<svg class="feather">
   <use href="{{ printf "%s#%s" $featherURL .Icon }}" />
</svg>
{{- end -}}

<header>
	<div class="main">
		<a href="{{ absLangURL "/" }}">{{ .Site.Title }}</a>
	</div>
	<nav>
		{{ range .Site.Menus.main }}
		<a href="{{ .URL }}">{{ .Name }}</a>
		{{ end }}
		<a href="https://github.com/itcaat" target="_blank" rel="noopener" class="social-icon github-icon" aria-label="GitHub" title="GitHub">
			<svg class="feather" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
			</svg>
		</a>
		<a href="https://x.com/itcaat" target="_blank" rel="noopener" class="social-icon x-icon" aria-label="X (Twitter)" title="X (Twitter)">
			<svg class="feather" viewBox="0 0 24 24" fill="currentColor" stroke="none">
				<path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
			</svg>
		</a>
		<a href="https://t.me/devopsbrain" target="_blank" rel="noopener" class="social-icon telegram-icon" aria-label="Telegram канал" title="Подписаться на Telegram">
			<svg class="feather" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
			</svg>
		</a>
		{{ if eq .Site.Params.mode "toggle" -}}
		<button id="dark-mode-toggle" class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
			<svg class="feather" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<circle cx="12" cy="12" r="5"></circle>
				<line x1="12" y1="1" x2="12" y2="3"></line>
				<line x1="12" y1="21" x2="12" y2="23"></line>
				<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
				<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
				<line x1="1" y1="12" x2="3" y2="12"></line>
				<line x1="21" y1="12" x2="23" y2="12"></line>
				<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
				<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
			</svg>
		</button>
		<script src="{{ absURL "js/themetoggle.js" }}"></script>
		{{ end }}
		<button id="search-toggle" class="search-toggle" aria-label="Toggle search">
			<svg class="feather" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<circle cx="11" cy="11" r="8"></circle>
				<path d="m21 21-4.35-4.35"></path>
			</svg>
		</button>
	</nav>
</header>

<!-- Search Modal -->
<div id="search-modal" class="search-modal">
	<div class="search-modal-content">
		<div class="search-modal-header">
			<input type="text" id="search-input" placeholder="Поиск по постам..." autofocus>
			<button id="search-close" class="search-close" aria-label="Close search">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</button>
		</div>
		<div id="search-results" class="search-results">
			<p class="search-info">Введите запрос для поиска...</p>
		</div>
	</div>
</div>

<!-- Search Script -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
	let fuse;
	let searchData = [];
	const searchModal = document.getElementById('search-modal');
	const searchToggle = document.getElementById('search-toggle');
	const searchClose = document.getElementById('search-close');
	const searchInput = document.getElementById('search-input');
	const searchResults = document.getElementById('search-results');

	// Load search data
	fetch('/index.json')
		.then(response => response.json())
		.then(data => {
			searchData = data;
			const options = {
				keys: [
					{ name: 'title', weight: 3 },
					{ name: 'description', weight: 2 },
					{ name: 'content', weight: 1 },
					{ name: 'tags', weight: 2 }
				],
				threshold: 0.4,
				includeScore: true,
				minMatchCharLength: 2,
				ignoreLocation: true
			};
			fuse = new Fuse(searchData, options);
		});

	// Open search modal
	searchToggle.addEventListener('click', () => {
		searchModal.classList.add('active');
		searchInput.focus();
	});

	// Close search modal
	searchClose.addEventListener('click', () => {
		searchModal.classList.remove('active');
		searchInput.value = '';
		searchResults.innerHTML = '<p class="search-info">Введите запрос для поиска...</p>';
	});

	// Close on Escape
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape' && searchModal.classList.contains('active')) {
			searchModal.classList.remove('active');
			searchInput.value = '';
			searchResults.innerHTML = '<p class="search-info">Введите запрос для поиска...</p>';
		}
	});

	// Close on backdrop click
	searchModal.addEventListener('click', (e) => {
		if (e.target === searchModal) {
			searchModal.classList.remove('active');
			searchInput.value = '';
			searchResults.innerHTML = '<p class="search-info">Введите запрос для поиска...</p>';
		}
	});

	// Search on input
	searchInput.addEventListener('input', (e) => {
		const query = e.target.value.trim();
		
		if (!query) {
			searchResults.innerHTML = '<p class="search-info">Введите запрос для поиска...</p>';
			return;
		}

		if (query.length < 2) {
			searchResults.innerHTML = '<p class="search-info">Введите минимум 2 символа...</p>';
			return;
		}

		const results = fuse.search(query);
		
		if (results.length === 0) {
			searchResults.innerHTML = '<p class="search-info">Ничего не найдено.</p>';
			return;
		}

		let html = `<div class="search-count">Найдено: ${results.length}</div>`;
		
		results.slice(0, 10).forEach(result => {
			const item = result.item;
			const date = new Date(item.date).toLocaleDateString('ru-RU', {
				year: 'numeric',
				month: 'short',
				day: 'numeric'
			});
			
			const tags = item.tags ? item.tags.slice(0, 3).map(tag => 
				`<span class="search-tag">${tag}</span>`
			).join('') : '';
			
			html += `
				<a href="${item.permalink}" class="search-result-item">
					<div class="search-result-title">${item.title}</div>
					<div class="search-result-meta">
						<span class="search-result-date">${date}</span>
						${tags}
					</div>
					${item.description ? `<div class="search-result-desc">${item.description.substring(0, 150)}${item.description.length > 150 ? '...' : ''}</div>` : ''}
				</a>
			`;
		});
		
		searchResults.innerHTML = html;
	});

	// Keyboard shortcut: Ctrl+K or Cmd+K
	document.addEventListener('keydown', (e) => {
		if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
			e.preventDefault();
			searchModal.classList.add('active');
			searchInput.focus();
		}
	});
</script>

